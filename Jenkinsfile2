pipeline {
   agent any

     environment {

        BUILD_NUMBER = "${env.BUILD_NUMBER}"
        MAVEN_IMAGE = "houcemdevops/maven-app:${env.BUILD_NUMBER}"
        
     }
   
    stages {
        stage('Clone'){
            steps{
              checkout scm 
                
            }
        }
        
        stage('Build IMAGE'){
            steps{
               script  {

                   docker.build("${env.MAVEN_IMAGE}", '.')
               }
            }
        }  
        
         stage('PUSH IMAGE'){
            steps{
               script  {
                   withDockerRegistry(credentialsId: 'id_docker') {
                                     docker.image("${env.MAVEN_IMAGE}").push()

                }

                   
               }
            }
        }  




        stage('Deploy K8s'){
            environment {
                          GIT_REPO_NAME = "myapp-j2e-g19"
                          GIT_USER_NAME = "houcem"
                          MAVEN_REPO = "houcemdevops/maven-app"
               
                  }

            steps{
               dir('maven'){
              withCredentials([string(credentialsId: 'GITLAB_TOKEN', variable: 'GITLAB_TOKEN')]) {

          
                          sh '''
                              git config user.email "houcem@test.com"
                              git config user.name "houcem" 
                              BUILD_NUMBER=${BUILD_NUMBER}
                              echo ${BUILD_NUMBER} 
                              imageTag=$(grep -oP '(?<=maven-app:)[^ ]+' maven.yaml)
                              echo $imageTag
                              sed -i "s|${MAVEN_REPO}:${imageTag}|${MAVEN_IMAGE}|" maven.yaml 
                              git add maven.yaml
                              git commit -m "Update deployement Image to version \${BUILD_NUMBER}"
                              git push https://${GITLAB_TOKEN}:${GIT_USER_NAME}@repo-dev.efi-academy.com/${GIT_USER_NAME}/${GIT_REPO_NAME} HEAD:master
                              ''' 
    
              }


                    }
                

                
            }
        }
       
    }
    
}

